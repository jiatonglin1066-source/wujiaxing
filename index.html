<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>功课记录板 · 本地版</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --muted:#667085;
    --line:#edf0f5;
    /* 主题色：与顶部一致的柔和米杏色系 */
    --header-bg:#FAEECA;         /* 顶部栏背景色 */
    --accent:#E3C880;            /* 顶部色系的加深，用于按钮文字等 */
    --brand:#D9B05A;             /* 主要按钮（添加/确认）采用更饱和的同系金黄 */
    --danger:#b42318;
    --shadow:0 8px 24px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:var(--bg); color:#222;}
  .wrap{max-width:1080px; margin:0 auto; padding:16px;}
  header{background:var(--header-bg); border-radius:16px; padding:14px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:16px;}
  h1{font-size:20px; margin:0;}
  .actions{display:flex; gap:8px; flex-wrap:wrap;}
  button{height:36px; padding:0 14px; border-radius:10px; border:1px solid var(--line); cursor:pointer; font-size:14px; background:#fff;}
  .primary{background:var(--brand); color:#fff; border:none;}
  .secondary{background:var(--header-bg); color:#7A5E1C; border-color:#F2E3B2;} /* 与顶部同系的柔和按钮 */
  .grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
  .card{background:var(--card); border-radius:16px; box-shadow:var(--shadow); padding:16px;}
  .name{font-weight:700; font-size:18px;}
  .kpi{font-size:22px; font-weight:800;}
  .line{height:1px; background:var(--line); margin:10px 0;}
  .muted{color:var(--muted); font-size:13px;}
  .row{display:flex; justify-content:space-between; align-items:center; gap:8px;}
  .tag{background:#fafbff; border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px;}
  .list{display:grid; gap:8px;}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:var(--header-bg); border:1px solid #F2E3B2; border-radius:999px; font-size:12px; color:#7A5E1C;}
  /* modal */
  .modalMask{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:10;}
  .modal{background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:16px; width:min(680px,100%);}
  .modal h2{margin:0 0 8px; font-size:18px;}
  input,select,textarea{width:100%; height:40px; margin-top:8px; padding:0 10px; border:1px solid var(--line); border-radius:10px; font-size:14px;}
  textarea{height:84px; padding:10px;}
  .modalActions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px;}
  .danger{color:var(--danger); cursor:pointer; text-decoration:underline;}
  table{width:100%; border-collapse:collapse; font-size:14px; margin-top:8px;}
  th,td{border-bottom:1px solid var(--line); padding:6px 8px; text-align:left;}
  .right{margin-left:auto;}
  .chkline{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0;}
  .hint{font-size:12px; color:#6b7280;}
</style>
</head>
<body>

<!-- 访问密码 -->
<div id="loginMask" class="modalMask" style="display:flex;">
  <div class="modal" style="max-width:360px;">
    <h2>请输入访问密码</h2>
    <input id="accessCode" placeholder="访问码" type="password" />
    <div class="modalActions">
      <button class="primary" onclick="checkAccess()">进入</button>
    </div>
    <p id="loginError" class="muted"></p>
  </div>
</div>

<div class="wrap" id="app" style="display:none;">
  <header>
    <h1>功课记录板</h1>
    <div class="actions">
      <button class="primary" onclick="openAdd()">＋ 添加记录</button>
      <button class="secondary" onclick="openAdmin()">管理员入口</button>
    </div>
  </header>

  <div class="grid" id="grid"></div>
</div>

<!-- 添加记录 -->
<div class="modalMask" id="addMask">
  <div class="modal">
    <h2>添加记录</h2>
    <label>选择名字</label>
    <select id="selName"></select>
    <label>选择项目（固定）</label>
    <select id="selProj">
      <option value="全身运动">全身运动</option>
      <option value="GY">GY</option>
      <option value="FX">FX</option>
      <option value="BZM">BZM</option>
      <option value="GMZ">GMZ</option>
      <option value="SSYJ">SSYJ</option>
      <option value="静坐">静坐</option>
    </select>
    <label>数量（次）</label>
    <input id="count" type="number" min="1" step="1" placeholder="正整数"/>
    <label>备注（可选）</label>
    <input id="note" placeholder="例如：早练/晚练"/>
    <div class="modalActions">
      <button onclick="closeMask('addMask')">取消</button>
      <button class="primary" onclick="submitRecord()">提交</button>
    </div>
  </div>
</div>

<!-- 查看个人记录 / 自选卡片展示项目（最多2个） / 删除 -->
<div class="modalMask" id="viewMask">
  <div class="modal">
    <h2 id="viewTitle">我的记录</h2>

    <!-- 自选：除静坐外，最多再选 2 项 -->
    <div style="margin:6px 0 2px;" class="muted">卡片显示项目（固定包含「静坐」，这里最多再选 <b>2</b> 项）：</div>
    <div class="chkline" id="displayBox"></div>
    <div class="row">
      <span class="hint">已选 <span id="dispCount">0</span> / 2</span>
      <span class="right"></span>
      <button class="secondary" onclick="saveDisplayChoice()">保存显示项目</button>
    </div>

    <div class="row" style="margin-top:8px;">
      <select id="filterProj">
        <option value="">全部项目</option>
        <option value="全身运动">全身运动</option><option value="GY">GY</option>
        <option value="FX">FX</option><option value="BZM">BZM</option>
        <option value="GMZ">GMZ</option><option value="SSYJ">SSYJ</option>
        <option value="静坐">静坐</option>
      </select>
      <span class="right pill" id="recCount"></span>
    </div>
    <table id="recTable">
      <thead><tr><th>时间</th><th>项目</th><th>数量</th><th>备注</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="modalActions">
      <button class="secondary" onclick="closeMask('viewMask')">关闭</button>
    </div>
  </div>
</div>

<!-- 管理员入口（登录+面板） -->
<div class="modalMask" id="adminLoginMask">
  <div class="modal" style="max-width:360px;">
    <h2>管理员验证</h2>
    <input id="adminPwd" placeholder="管理员密码" type="password"/>
    <div class="modalActions">
      <button class="secondary" onclick="closeMask('adminLoginMask')">取消</button>
      <button class="primary" onclick="enterAdmin()">进入</button>
    </div>
    <p class="muted" id="adminLoginError"></p>
  </div>
</div>

<div class="modalMask" id="adminMask">
  <div class="modal">
    <h2>管理员面板</h2>
    <div class="row" style="gap:8px; flex-wrap:wrap;">
      <button class="secondary" onclick="showTab('people')">人员</button>
      <button class="secondary" onclick="showTab('trash')">回收站</button>
      <span class="right"></span>
      <button class="secondary" onclick="closeMask('adminMask')">关闭</button>
    </div>
    <div id="tab_people">
      <h3>管理人员（仅管理员可添加/删除成员、设置默认展示项目与 PIN）</h3>
      <div class="row" style="gap:8px; flex-wrap:wrap;">
        <input id="newPerson" placeholder="新增成员名字"/>
        <button class="primary" onclick="adminAddPerson()">添加成员</button>
      </div>
      <table>
        <thead><tr><th>成员</th><th>默认展示项目(单选)</th><th>PIN</th><th>操作</th></tr></thead>
        <tbody id="peopleBody"></tbody>
      </table>
      <div class="hint" style="margin-top:6px;">说明：成员可在“查看记录”里自选最多 2 个项目展示（静坐固定）。</div>
    </div>
    <div id="tab_trash" style="display:none;">
      <h3>回收站（保留 24 小时）</h3>
      <div class="row">
        <span class="pill" id="trashHint"></span>
        <span class="right"></span>
        <button class="danger" onclick="purgeExpired()">清空过期</button>
      </div>
      <table>
        <thead><tr><th>删除时间</th><th>成员</th><th>项目</th><th>数量</th><th>备注</th><th>剩余(h)</th><th>操作</th></tr></thead>
        <tbody id="trashBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/** ================= 配置 ================= */
const ACCESS_PASSWORD = "1666";        // 访问密码
const ADMIN_PASSWORD  = "1666-admin";  // 管理员密码（可改）
const FIXED_PROJECTS = ["全身运动","GY","FX","BZM","GMZ","SSYJ","静坐"];
const SELECTABLE_FOR_DISPLAY = ["全身运动","GY","FX","BZM","GMZ","SSYJ"]; // “静坐”固定，不在这里
const MAX_DISPLAY = 2;                 // ★ 用户最多选择 2 个
const TRASH_TTL_MS = 24*3600*1000;     // 回收站保留 24 小时
const STORAGE_KEY = "gongke_board_local_v5";

/** ================= 状态与存储 ================= */
function load(){
  try{
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    return {
      people:   s.people   || ["圆法","小宝"],
      featured: s.featured || {"圆法":"全身运动","小宝":"GY"}, // 管理员默认单选
      pins:     s.pins     || {}, // {"圆法":"1234"}
      records:  s.records  || [],
      trash:    s.trash    || [],
      // 每个成员卡片上（除静坐外）还想显示的项目（最多 2 个）
      display:  s.display  || { "圆法": ["全身运动"], "小宝": ["GY"] }
    };
  }catch(e){ return {people:[],featured:{},pins:{},records:[],trash:[],display:{}}; }
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
let state = load();

/** ================= 入口验证 ================= */
function checkAccess(){
  const val = document.getElementById("accessCode").value.trim();
  if(val===ACCESS_PASSWORD){
    document.getElementById("loginMask").style.display="none";
    document.getElementById("app").style.display="block";
    render();
  } else {
    document.getElementById("loginError").textContent = "密码错误";
  }
}

/** ================= 工具 ================= */
const $ = (id)=>document.getElementById(id);
function closeMask(id){ $(id).style.display="none"; }
function openMask(id){ $(id).style.display="flex"; }
function fmt(dt){ const d=new Date(dt); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }
function nowStr(){ return fmt(Date.now()); }

/** ================= 页面渲染（按最近提交排序） ================= */
function render(){
  const grid = $("grid"); grid.innerHTML="";

  // 计算每人的最近提交时间，用于排序
  const persons = state.people.map(name=>{
    const recs = state.records.filter(r=>r.name===name);
    const lastTs = recs.length ? Math.max(...recs.map(r=>r.ts||0)) : 0;
    return {name, recs, lastTs};
  }).sort((a,b)=> b.lastTs - a.lastTs || a.name.localeCompare(b.name)); // 最新优先，无记录排后

  persons.forEach(({name,recs})=>{
    // 固定：静坐
    const totalSit = recs.filter(r=>r.proj==="静坐").reduce((s,r)=>s+r.count,0);

    // 用户自选要展示的项目（最多 2 个），兜底：若为空则用默认 featured
    const chosen = (state.display[name] && state.display[name].length)
      ? state.display[name].slice(0,MAX_DISPLAY)
      : [state.featured[name] || "全身运动"];

    // 生成“项目总数”DOM（静坐 + 自选）
    const totalsFrag = document.createElement("div");
    const sitRow = document.createElement("div"); sitRow.className="row"; sitRow.innerHTML = `<div>静坐总数：<span class="kpi">${totalSit}</span></div>`; totalsFrag.appendChild(sitRow);
    chosen.forEach(p=>{
      const sum = recs.filter(r=>r.proj===p).reduce((s,r)=>s+r.count,0);
      const row = document.createElement("div"); row.className="row"; row.style.marginTop="6px";
      row.innerHTML = `<div>${p} 总数：<span class="kpi">${sum}</span></div>`;
      totalsFrag.appendChild(row);
    });

    // 卡片骨架
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `
      <div class="row">
        <div class="name">${name}</div>
        <button class="pill" onclick="openView('${name}')">查看记录</button>
      </div>
      <div class="line"></div>
      <div class="muted">最近三次提交</div>
    `;
    // 插入 totals
    card.insertBefore(totalsFrag, card.children[2]);

    // 最近三次
    const list = document.createElement("div"); list.className="list";
    recs.slice(-3).reverse().forEach(r=>{
      const row = document.createElement("div"); row.className="row";
      row.innerHTML = `<span class="tag">${r.time}</span><span>${r.proj} ${r.count}</span>`;
      list.appendChild(row);
      if(r.note){ const nt=document.createElement("div"); nt.className="muted"; nt.textContent=r.note; list.appendChild(nt); }
    });
    card.appendChild(list);
    grid.appendChild(card);
  });
}

/** ================= 添加记录 ================= */
function fillSelectNames(selId){
  const sel = $(selId); sel.innerHTML = "";
  state.people.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; sel.appendChild(o); });
}
function openAdd(){
  fillSelectNames("selName");
  $("selProj").value="全身运动";
  $("count").value=""; $("note").value="";
  openMask("addMask");
}
function submitRecord(){
  const name = $("selName").value;
  const proj = $("selProj").value;
  const count = Number(($("count").value||"").trim());
  const note  = $("note").value.trim();
  if(!name || !proj || !Number.isInteger(count) || count<=0){ alert("请完整填写（数量需为正整数）"); return; }
  state.records.push({ id: crypto.randomUUID(), name, proj, count, note, time: nowStr(), ts: Date.now() });
  save(); closeMask("addMask"); render();
}

/** ================= 查看/删除个人记录（需 PIN） + 自选展示项目(≤2) ================= */
let currentViewer = null;
function openView(name){
  currentViewer = name;
  $("viewTitle").textContent = `${name} 的记录`;

  // 构建可选展示项目的复选框（不含静坐）
  const box = $("displayBox"); box.innerHTML="";
  const selected = new Set(state.display[name] || []);
  SELECTABLE_FOR_DISPLAY.forEach(p=>{
    const label = document.createElement("label"); label.style.marginRight="8px";
    const cb = document.createElement("input"); cb.type="checkbox"; cb.value=p;
    cb.checked = selected.has(p);
    cb.onchange = ()=>{
      const cur = new Set(state.display[name] || []);
      if(cb.checked){
        if(cur.size>=MAX_DISPLAY){ cb.checked=false; alert(`最多可选择 ${MAX_DISPLAY} 个项目`); return; }
        cur.add(p);
      }else{
        cur.delete(p);
      }
      state.display[name] = Array.from(cur);
      $("dispCount").textContent = state.display[name].length;
    };
    label.appendChild(cb); label.appendChild(document.createTextNode(" "+p));
    box.appendChild(label);
  });
  $("dispCount").textContent = (state.display[name]||[]).length;

  $("filterProj").value="";
  renderViewTable();
  openMask("viewMask");
}
function saveDisplayChoice(){ save(); render(); alert("已保存显示项目"); }

$("filterProj").addEventListener("change", renderViewTable);

function renderViewTable(){
  const tbody = $("recTable").querySelector("tbody"); tbody.innerHTML="";
  const projFilter = $("filterProj").value;
  const list = state.records
    .filter(r=>r.name===currentViewer && (!projFilter || r.proj===projFilter))
    .sort((a,b)=>b.ts-a.ts);
  $("recCount").textContent = `共 ${list.length} 条`;
  list.forEach(r=>{
    const tr = document.createElement("tr");
    const delBtn = document.createElement("button"); delBtn.className="secondary";
    delBtn.textContent = "删除";
    delBtn.onclick = ()=> deleteRecordWithPIN(r.id, r.name);
    tr.innerHTML = `<td>${r.time}</td><td>${r.proj}</td><td>${r.count}</td><td>${r.note||""}</td>`;
    const td = document.createElement("td"); td.appendChild(delBtn); tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

function deleteRecordWithPIN(id, name){
  const pinSet = state.pins[name];
  if(!pinSet){ alert(`此成员尚未设置 PIN，请联系管理员设置后再删除。`); return; }
  const pin = prompt(`请输入 ${name} 的 PIN（4 位数字）以删除该记录：`);
  if(pin!==pinSet){ alert("PIN 不正确"); return; }
  const idx = state.records.findIndex(r=>r.id===id);
  if(idx>-1){
    const rec = state.records[idx];
    state.records.splice(idx,1);
    state.trash.push({ rec, deletedAt: Date.now() });
    save(); render(); renderViewTable();
  }
}

/** ================= 管理员入口 ================= */
function openAdmin(){ $("adminLoginError").textContent=""; openMask("adminLoginMask"); }
function enterAdmin(){
  const pwd = $("adminPwd").value.trim();
  if(pwd===ADMIN_PASSWORD){
    closeMask("adminLoginMask");
    showTab('people'); openMask("adminMask"); renderAdminPeople(); renderTrash();
  } else { $("adminLoginError").textContent="密码错误"; }
}
function showTab(which){
  $("tab_people").style.display = which==='people'?'block':'none';
  $("tab_trash").style.display  = which==='trash' ?'block':'none';
}

/* 人员管理（默认展示项目单选 + PIN） */
function renderAdminPeople(){
  const body = $("peopleBody"); body.innerHTML="";
  state.people.forEach(name=>{
    const tr = document.createElement("tr");

    // 默认展示项目（单选，仅用于兜底；成员可在“查看记录”里自选最多2个）
    const sel = document.createElement("select");
    FIXED_PROJECTS.forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; sel.appendChild(o); });
    sel.value = state.featured[name] || "全身运动";
    sel.onchange = ()=>{ state.featured[name]=sel.value; save(); render(); };

    // PIN 设置
    const pinInput = document.createElement("input"); pinInput.placeholder="4位数字"; pinInput.maxLength=4;
    pinInput.value = state.pins[name] || "";
    pinInput.onchange = ()=>{
      const v = pinInput.value.trim();
      if(v && !/^\d{4}$/.test(v)){ alert("PIN 必须为4位数字"); pinInput.value = state.pins[name]||""; return; }
      state.pins[name]=v; save();
    };

    // 删除成员
    const tdOp = document.createElement("td");
    const delBtn = document.createElement("button"); delBtn.className="secondary"; delBtn.textContent="删除成员";
    delBtn.onclick = ()=>{
      if(confirm(`删除成员「${name}」？（不会删除其历史记录）`)){
        state.people = state.people.filter(n=>n!==name);
        delete state.featured[name]; delete state.pins[name]; delete state.display[name];
        save(); renderAdminPeople(); render();
      }
    };
    tdOp.appendChild(delBtn);

    tr.innerHTML = `<td>${name}</td>`;
    const tdFeat = document.createElement("td"); tdFeat.appendChild(sel);
    const tdPin  = document.createElement("td"); tdPin.appendChild(pinInput);
    tr.appendChild(tdFeat); tr.appendChild(tdPin); tr.appendChild(tdOp);
    body.appendChild(tr);
  });
}
function adminAddPerson(){
  const name = $("newPerson").value.trim();
  if(!name){ alert("请输入成员名字"); return; }
  if(state.people.includes(name)){ alert("该成员已存在"); return; }
  state.people.push(name);
  // 默认：成员的卡片会显示 静坐 + featured（成员可在查看记录中再改最多2个）
  state.display[name] = [state.featured[name] || "全身运动"];
  save();
  $("newPerson").value=""; renderAdminPeople(); render();
}

/* 回收站 */
function hoursLeft(endTs){ return Math.max(0, Math.ceil((endTs - Date.now())/3600000)); }
function renderTrash(){
  const tbody = $("trashBody"); tbody.innerHTML="";
  const valid = state.trash.sort((a,b)=>b.deletedAt-a.deletedAt);
  $("trashHint").textContent = `共 ${valid.length} 条（24h 内可恢复）`;
  valid.forEach(t=>{
    const rec = t.rec;
    const deadline = t.deletedAt + TRASH_TTL_MS;
    const hleft = hoursLeft(deadline);
    const tr = document.createElement("tr");
    const restoreBtn = document.createElement("button"); restoreBtn.className="secondary";
    restoreBtn.textContent = "恢复";
    restoreBtn.disabled = (Date.now()>deadline);
    restoreBtn.onclick = ()=>{
      if(Date.now()>deadline){ alert("已过期，无法恢复"); return; }
      state.records.push(rec);
      state.trash = state.trash.filter(x=>x!==t);
      save(); renderTrash(); render();
    };
    const rmBtn = document.createElement("button"); rmBtn.className="secondary"; rmBtn.textContent="彻底删除";
    rmBtn.onclick = ()=>{
      if(confirm("彻底删除此记录？该操作不可恢复")){ 
        state.trash = state.trash.filter(x=>x!==t); save(); renderTrash(); 
      }
    };
    tr.innerHTML = `<td>${fmt(t.deletedAt)}</td><td>${rec.name}</td><td>${rec.proj}</td><td>${rec.count}</td><td>${rec.note||""}</td><td>${hleft}</td>`;
    const td=document.createElement("td"); td.appendChild(restoreBtn); td.appendChild(document.createTextNode(" ")); td.appendChild(rmBtn);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}
function purgeExpired(){
  const before = state.trash.length;
  state.trash = state.trash.filter(t=> (t.deletedAt + TRASH_TTL_MS) > Date.now());
  const removed = before - state.trash.length;
  save(); renderTrash();
  alert(`已清理过期 ${removed} 条`);
}
</script>
</body>
</html>
