<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>功课记录板 · 云端版</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root{
    --bg:#faf9f7;--card:#fff;--text:#222;--muted:#666;--brand:#7c5cff;
    --chip:#f1f0ff; --chip-on:#e7e5ff; --line:#eceaea; --ok:#0a7;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:920px;margin:0 auto;padding:16px 14px 80px}
  header{
    position:sticky;top:0;z-index:10;background:var(--bg);
    padding:10px 0 8px;margin-bottom:6px;
  }
  .bar{display:flex;align-items:center;gap:8px}
  .title{font-size:20px;font-weight:700;letter-spacing:.5px;margin-right:auto}
  .btn{appearance:none;border:0;border-radius:10px;background:var(--brand);color:#fff;padding:10px 14px;font-weight:600}
  .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .grid{display:grid;gap:14px}
  .card{
    background:var(--card);border-radius:16px;border:1px solid var(--line);
    padding:14px 14px 12px;box-shadow:0 1px 0 rgba(0,0,0,.04)
  }
  .row{display:flex;align-items:center}
  .row.space{justify-content:space-between;gap:8px}
  .name{font-size:18px;font-weight:700}
  .meta{color:var(--muted);font-size:13px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 2px}
  .chip{
    padding:6px 10px;border-radius:999px;background:var(--chip);
    border:1px solid var(--line);font-size:13px;display:inline-flex;gap:6px;align-items:center
  }
  .chip.on{background:var(--chip-on);border-color:#d9d6ff}
  .stat{display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .pill{background:#f6f6f6;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px}
  .primary{color:#111;background:#f2f0ff;border-color:#e3e0ff}
  .muted{color:var(--muted)}
  .actions{display:flex;gap:8px}
  .link{font-weight:600;color:#333;text-decoration:none;background:#f6f6f6;border:1px solid var(--line);padding:8px 10px;border-radius:10px}
  .hidden{display:none}
  footer{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:var(--bg);padding:8px}
  .note{max-width:920px;margin:0 auto;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block;margin-right:6px}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="bar">
        <div class="title">功课记录板 · 云端版</div>
        <button id="btnAdd" class="btn">＋ 添加记录</button>
        <button id="btnAdmin" class="btn ghost">管理员入口</button>
      </div>
      <div class="meta" id="subtitle">Supabase 实时读写 · 软删除 + 回收站 · 成员管理</div>
    </header>

    <div id="memberList" class="grid"></div>
  </div>

  <footer><div class="note"><span class="dot"></span> 实时已连接。新增 / 删除会自动刷新排序（最近提交排最上）。</div></footer>

  <!-- Add Record 简易弹窗（原有流程保留） -->
  <dialog id="dlgAdd" style="max-width:560px;border:0;border-radius:16px;padding:14px">
    <form id="formAdd" method="dialog">
      <h3 style="margin:0 0 8px">添加记录</h3>
      <div style="display:grid;gap:10px">
        <label>成员
          <select id="addMember" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px"></select>
        </label>
        <label>项目
          <select id="addItem" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
            <option>GMZ</option><option>GY</option><option>FX</option>
            <option>BZM</option><option>SSYJ</option><option>静坐</option><option>全身运动</option>
          </select>
        </label>
        <label>数量
          <input id="addQty" type="number" inputmode="numeric" min="1" value="1"
                 style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px" required />
        </label>
        <label>单位
          <input id="addUnit" value="次" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px" />
        </label>
        <label>备注
          <input id="addNote" placeholder="可留空" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px" />
        </label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button type="button" id="btnCancelAdd" class="btn ghost">取消</button>
        <button type="submit" class="btn">提交</button>
      </div>
    </form>
  </dialog>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://bpgzzgmghkcwpoalhrrd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwZ3p6Z21naGtjd3BvYWxocnJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0OTEwMTgsImV4cCI6MjA3MzA2NzAxOH0.5PtBu34Gi0NjupUgVSQZqYWZdkfjVQFhucyfwLINI1g";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** 固定显示的项目 + 允许自选的候选项 */
const FIXED_METRIC = "静坐";
const ITEM_OPTIONS = ["GMZ","GY","FX","BZM","SSYJ","静坐","全身运动"];

/** 状态 */
let isAdmin = localStorage.getItem("gk_admin_ok") === "1";
let members = [];                 // [{id,name,is_active,disp_metric1,disp_metric2,...}]
const statsByMember = new Map();  // id -> { totals: { item:sum }, last: ISO String }

const $list = document.getElementById("memberList");
const $btnAdmin = document.getElementById("btnAdmin");
const $btnAdd = document.getElementById("btnAdd");
const $dlgAdd = document.getElementById("dlgAdd");
const $formAdd = document.getElementById("formAdd");
const $addMember = document.getElementById("addMember");
const $addItem = document.getElementById("addItem");
const $addQty = document.getElementById("addQty");
const $addUnit = document.getElementById("addUnit");
const $addNote = document.getElementById("addNote");
document.getElementById("btnCancelAdd").onclick = ()=> $dlgAdd.close();

/*------------------------- 数据加载与聚合 -------------------------*/

async function loadAll() {
  const [mRes, rRes] = await Promise.all([
    supabase.from("members").select("id,name,is_active,disp_metric1,disp_metric2").order("id"),
    supabase.from("records").select("member_id,item,quantity,submitted_at,is_deleted")
  ]);
  if (mRes.error) { console.error(mRes.error); return; }
  if (rRes.error) { console.error(rRes.error); return; }

  members = (mRes.data || []).filter(m => m.is_active !== false);
  statsByMember.clear();

  (rRes.data || []).forEach(addRecordToStats);

  renderAll();
  bindRealtime();
}

function addRecordToStats(r) {
  if (r.is_deleted) return;
  const id = r.member_id;
  let s = statsByMember.get(id);
  if (!s) { s = { totals: {}, last: null }; statsByMember.set(id, s); }
  const key = r.item || "";
  const qty = Number(r.quantity || 0);
  s.totals[key] = (s.totals[key] || 0) + qty;
  if (!s.last || new Date(r.submitted_at) > new Date(s.last)) {
    s.last = r.submitted_at;
  }
}

/*------------------------- 渲染 -------------------------*/

function renderAll() {
  // 供「添加记录」选择成员
  $addMember.innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join("");

  // 按最近提交时间排序（无提交排后面）
  const sorted = [...members].sort((a,b) => {
    const la = statsByMember.get(a.id)?.last;
    const lb = statsByMember.get(b.id)?.last;
    return new Date(lb || 0) - new Date(la || 0);
  });

  $list.innerHTML = "";
  sorted.forEach(m => $list.appendChild(renderCard(m)));
}

function renderCard(m) {
  const s = statsByMember.get(m.id) || { totals:{}, last:null };
  const jz = s.totals[FIXED_METRIC] || 0;
  const pick = [m.disp_metric1, m.disp_metric2].filter(Boolean);
  const p1 = pick[0] || "";
  const p2 = pick[1] || "";

  // 元素
  const el = document.createElement("div");
  el.className = "card";

  const chip = (label, total, on=false) =>
    `<span class="chip ${on?'on':''}"><b>${label}</b><span class="muted">${total}</span></span>`;

  const pills = [];
  pills.push(`<span class="pill primary">静坐总数：<b>${jz}</b></span>`);
  if (p1) pills.push(`<span class="pill"> ${p1}：<b>${s.totals[p1] || 0}</b></span>`);
  if (p2) pills.push(`<span class="pill"> ${p2}：<b>${s.totals[p2] || 0}</b></span>`);

  el.innerHTML = `
    <div class="row space">
      <div class="name">${m.name}</div>
      <div class="actions">
        <a class="link" data-act="view" href="javascript:">查看记录</a>
      </div>
    </div>

    <div class="stat">${pills.join("")}
      <span class="muted" style="margin-left:auto">
        ${s.last ? `最近：${fmt(s.last)}` : "尚无提交"}
      </span>
    </div>

    <div class="chips" data-id="${m.id}">
      ${ITEM_OPTIONS.map(it => chip(it, s.totals[it] || 0, [p1,p2].includes(it))).join("")}
    </div>
  `;

  // 选两个展示项目（仅管理员可改）
  const chipsBox = el.querySelector(".chips");
  chipsBox.onclick = async (e) => {
    if (!isAdmin) return;
    const id = Number(chipsBox.dataset.id);
    const label = e.target.closest(".chip")?.querySelector("b")?.textContent;
    if (!label) return;

    let next = [p1,p2].filter(Boolean);
    const i = next.indexOf(label);
    if (i >= 0) next.splice(i,1);   // 取消选择
    else if (next.length < 2) next.push(label);  // 选择最多两项
    else return; // 已经两个了

    await supabase.from("members").update({
      disp_metric1: next[0] || null,
      disp_metric2: next[1] || null
    }).eq("id", id);

    // 更新内存后重渲染
    const mref = members.find(x => x.id === id);
    mref.disp_metric1 = next[0] || null;
    mref.disp_metric2 = next[1] || null;
    renderAll();
  };

  // 查看记录（沿用你现有逻辑：打开另一个页面/弹窗都行；这里先简单 alert 最近 5 条）
  el.querySelector('[data-act="view"]').onclick = async () => {
    const { data } = await supabase.from('records')
      .select('item,quantity,unit,note,submitted_at')
      .eq('member_id', m.id).eq('is_deleted', false)
      .order('submitted_at', { ascending:false }).limit(5);
    alert((data||[]).map(r=>`${fmt(r.submitted_at)}  ${r.item} ${r.quantity}${r.unit||''} ${r.note||''}`).join('\n') || '暂无记录');
  };

  return el;
}

function fmt(iso){ const d=new Date(iso); const p=n=>`${n}`.padStart(2,'0'); return `${d.getMonth()+1}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }

/*------------------------- 实时 -------------------------*/
let _chan = null;
function bindRealtime(){
  if (_chan) return;
  _chan = supabase.channel('realtime-records')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'records'},payload=>{
      addRecordToStats(payload.new);   // 增量更新统计
      renderAll();                     // 重排
    })
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'records'},async payload=>{
      // 若被软删除，则重算该成员统计（简单保险）
      if (payload.new.is_deleted && !payload.old.is_deleted) {
        const id = payload.new.member_id;
        const { data } = await supabase.from('records')
          .select('member_id,item,quantity,submitted_at,is_deleted').eq('member_id', id);
        // 重算该成员
        statsByMember.set(id, { totals:{}, last:null });
        (data||[]).forEach(addRecordToStats);
        renderAll();
      }
    })
    .subscribe();
}

/*------------------------- 管理入口 -------------------------*/
$btnAdmin.onclick = ()=>{
  if (isAdmin) {
    isAdmin = false; localStorage.removeItem("gk_admin_ok");
    alert("已退出管理员模式");
  } else {
    const pin = prompt("请输入管理员密码");
    // 依旧与本地版一致：前端校验（若你需要改为 SHA256 校验也可以）
    if (pin && pin.trim() === "8899") { // ← 这里写你的口令
      isAdmin = true; localStorage.setItem("gk_admin_ok","1");
      alert("已进入管理员模式");
    } else {
      alert("密码不正确");
    }
  }
};

/*------------------------- 添加记录 -------------------------*/
$btnAdd.onclick = ()=> $dlgAdd.showModal();

$formAdd.onsubmit = async (e)=>{
  e.preventDefault();
  const payload = {
    member_id: Number($addMember.value),
    item: $addItem.value,
    quantity: Number($addQty.value || 0),
    unit: $addUnit.value || '',
    note: $addNote.value || ''
  };
  const { error } = await supabase.from('records').insert(payload);
  if (error) { alert("提交失败："+error.message); return; }
  $dlgAdd.close();
  $addQty.value = 1; $addNote.value = '';
};

/* 启动 */
loadAll();
</script>
</body>
</html>
